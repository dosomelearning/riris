AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  riris-backend

Parameters:
  CostAllocationTagValue:
    Type: String
    Default: "riris"
    Description: "Tag for tracking cost of used resources"
  CognitoUserPoolId:
    Type: String
    Default: "eu-central-1_SA3OzWXIm"
  CORSAllowOrigin:
    Type: String
    Default: "*"
  FilesBucketName:
    Default: "riris-files-ru7btob1t3"
    Type: String
    Description: "Existing S3 bucket name for file data (managed outside this stack)"
  S3Prefix:
    Type: String
    Default: "files"
    Description: "S3 key prefix for objects, e.g. files/<fileId>"
  DefaultExpiresDays:
    Type: Number
    Default: 7
    Description: "System default for file expiry (days)"
  MaxExpiresDays:
    Type: Number
    Default: 30
    Description: "System max for file expiry (days)"
  PresignPutExpiresSeconds:
    Type: Number
    Default: 900
    Description: "Expiry for presigned PUT URL (seconds)"
  PresignGetExpiresSeconds:
    Type: Number
    Default: 900
    Description: "Expiry for presigned GET URL (seconds)"

Resources:
  BackendTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${AWS::StackName}-files-data"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: fileId
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: GSI1
          KeySchema:
            - AttributeName: fileId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      Tags:
        - Key: CostAllocation
          Value: !Ref CostAllocationTagValue

  FilesBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      BucketName: "riris-files-ru7btob1t3"
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders:
              - "*"
            AllowedMethods:
              - GET
              - PUT
              - HEAD
            AllowedOrigins:
              - "http://localhost:5173"
              - !Sub "https://riris.dev.nothere.net"
            ExposedHeaders:
              - ETag
              - x-amz-request-id
              - x-amz-id-2
            MaxAge: 3000
      Tags:
        - Key: CostAllocation
          Value: !Ref CostAllocationTagValue

  RIRISApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Prod
      Auth:
        AddDefaultAuthorizerToCorsPreflight: False
        Authorizers:
          CognitoAuthorizer:
            UserPoolArn: !Sub arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/${CognitoUserPoolId}
      DefinitionBody:
        swagger: "2.0"
        info:
          securityDefinitions:
            CognitoAuthorizer:
              type: apiKey
              name: Authorization
              in: header
              x-amazon-apigateway-authtype: cognito_user_pools
              x-amazon-apigateway-authorizer:
                type: cognito_user_pools
                providerARNs:
                  - !Sub arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/${CognitoUserPoolId}
          title: "RIRIS Backend API"
          version: "1.0.1"
        # without these error definitions, every error looks like CORS issue!!!
        x-amazon-apigateway-gateway-responses:
          DEFAULT_4XX:
            responseParameters:
              gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
              gatewayresponse.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
              gatewayresponse.header.Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
          DEFAULT_5XX:
            responseParameters:
              gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
              gatewayresponse.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
              gatewayresponse.header.Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"

          # (Optional but nice) Be explicit for common auth failures:
          UNAUTHORIZED:
            statusCode: 401
            responseParameters:
              gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
              gatewayresponse.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
              gatewayresponse.header.Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
          ACCESS_DENIED:
            statusCode: 403
            responseParameters:
              gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
              gatewayresponse.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
              gatewayresponse.header.Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
        paths:
          /public/files/{id}:
            options:
              summary: "CORS support for public metadata"
              responses:
                "200":
                  description: "CORS response"
                  headers:
                    Access-Control-Allow-Origin:
                      type: "string"
                    Access-Control-Allow-Methods:
                      type: "string"
                    Access-Control-Allow-Headers:
                      type: "string"
              x-amazon-apigateway-integration:
                type: "mock"
                requestTemplates:
                  application/json: '{"statusCode": 200}'
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                      method.response.header.Access-Control-Allow-Methods: "'OPTIONS,GET'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key'"
            get:
              summary: "Public file metadata for browser download page"
              security: [ ]   # explicitly public
              responses:
                "200":
                  description: "OK"
                "404":
                  description: "Not found"
                "403":
                  description: "Deleted"
                "410":
                  description: "Expired"
              x-amazon-apigateway-integration:
                type: "aws_proxy"
                httpMethod: POST
                uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${FilesFunction.Arn}/invocations"
                responses: { }

          /files:
            options:
              summary: "CORS support"
              responses:
                "200":
                  description: "CORS response"
                  headers:
                    Access-Control-Allow-Origin:
                      type: "string"
                    Access-Control-Allow-Methods:
                      type: "string"
                    Access-Control-Allow-Headers:
                      type: "string"
              x-amazon-apigateway-integration:
                type: "mock"
                requestTemplates:
                  application/json: '{"statusCode": 200}'
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                      method.response.header.Access-Control-Allow-Methods: "'OPTIONS,GET,POST'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key'"
            get:
              summary: "List users files"
              security:
                - CognitoAuthorizer: [ ]
              x-amazon-apigateway-integration:
                type: "aws_proxy"
                httpMethod: POST
                uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${FilesFunction.Arn}/invocations"
                responses: { }
              responses:
                "200":
                  description: "Successful response"
            post:
              summary: "Upload new file"
              security:
                - CognitoAuthorizer: [ ]
              x-amazon-apigateway-integration:
                type: "aws_proxy"
                httpMethod: POST
                uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${FilesFunction.Arn}/invocations"
                responses: { }
              responses:
                "200":
                  description: "Successful response"
          /files/{id}:
            options:
              summary: "CORS support for DELETE, PUT, GET"
              responses:
                "200":
                  description: "CORS response"
                  headers:
                    Access-Control-Allow-Origin:
                      type: "string"
                    Access-Control-Allow-Methods:
                      type: "string"
                    Access-Control-Allow-Headers:
                      type: "string"
              x-amazon-apigateway-integration:
                type: "mock"
                requestTemplates:
                  application/json: '{"statusCode": 200}'
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                      method.response.header.Access-Control-Allow-Methods: "'OPTIONS,GET,PUT,DELETE'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key'"
            get:
              summary: "Public download (redirect)"
              responses:
                "302":
                  description: Redirect to pre-signed S3 URL
                "404":
                  description: Not found
                "410":
                  description: Expired
                "403":
                  description: Deleted / not allowed
              x-amazon-apigateway-integration:
                type: "aws_proxy"
                httpMethod: POST
                uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${FilesFunction.Arn}/invocations"
                responses: { }
            delete:
              summary: "Delete file"
              security:
                - CognitoAuthorizer: [ ]
              x-amazon-apigateway-integration:
                type: "aws_proxy"
                httpMethod: POST
                uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${FilesFunction.Arn}/invocations"
                responses: { }
              responses:
                "200":
                  description: "Successful response"

  ApiGatewayDefault4xx:
    Type: AWS::ApiGateway::GatewayResponse
    Properties:
      RestApiId: !Ref RIRISApi
      ResponseType: DEFAULT_4XX
      StatusCode: '400'
      ResponseParameters:
        gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
        gatewayresponse.header.Access-Control-Allow-Headers: "'Content-Type,Authorization,X-Requested-With'"
        gatewayresponse.header.Access-Control-Allow-Methods: "'GET,POST,PUT,PATCH,DELETE,OPTIONS'"
      ResponseTemplates:
        application/json: '{"message":$context.error.messageString}'

  ApiGatewayDefault5xx:
    Type: AWS::ApiGateway::GatewayResponse
    Properties:
      RestApiId: !Ref RIRISApi
      ResponseType: DEFAULT_5XX
      StatusCode: '500'
      ResponseParameters:
        gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
        gatewayresponse.header.Access-Control-Allow-Headers: "'Content-Type,Authorization,X-Requested-With'"
        gatewayresponse.header.Access-Control-Allow-Methods: "'GET,POST,PUT,PATCH,DELETE,OPTIONS'"
      ResponseTemplates:
        application/json: '{"message":"Internal Server Error"}'

  AllowApiInvokeFilesFunctionGetFiles:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref FilesFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RIRISApi}/Prod/GET/files"

  AllowApiInvokeFilesFunctionPostFiles:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref FilesFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RIRISApi}/Prod/POST/files"

  AllowApiInvokeFilesFunctionGetFileById:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref FilesFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RIRISApi}/Prod/GET/files/*"

  AllowApiInvokeFilesFunctionDeleteFileById:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref FilesFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RIRISApi}/Prod/DELETE/files/*"

  AllowApiInvokeFilesFunctionGetPublicMetadata:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref FilesFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RIRISApi}/Prod/GET/public/files/*"

  FilesFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${AWS::StackName}-FilesFunctionRole"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: !Sub "${AWS::StackName}-FilesFunctionAccess"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:Query
                  - dynamodb:PutItem
                  - dynamodb:DeleteItem
                  - dynamodb:UpdateItem
                  - dynamodb:TransactWriteItems
                Resource:
                  - !GetAtt BackendTable.Arn
                  - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${BackendTable}/index/*"
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                Resource: !Sub "arn:aws:s3:::${FilesBucketName}/${S3Prefix}/*"
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: "*"
      Tags:
        - Key: CostAllocation
          Value: !Ref CostAllocationTagValue

  FilesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-FilesFunction"
      Handler: main.handler
      Runtime: python3.12
      CodeUri: src/files/
      MemorySize: 256
      Timeout: 10
      Role: !GetAtt FilesFunctionRole.Arn
      Environment:
        Variables:
          LOG_LEVEL: INFO
          BACKEND_TABLE: !Ref BackendTable
          FILES_BUCKET: !Ref FilesBucketName
          S3_PREFIX: !Ref S3Prefix
          DEFAULT_EXPIRES_DAYS: !Ref DefaultExpiresDays
          MAX_EXPIRES_DAYS: !Ref MaxExpiresDays
          PRESIGN_PUT_EXPIRES_SECONDS: !Ref PresignPutExpiresSeconds
          PRESIGN_GET_EXPIRES_SECONDS: !Ref PresignGetExpiresSeconds

  S3ObjectCreatedFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${AWS::StackName}-S3ObjectCreatedFunctionRole"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: !Sub "${AWS::StackName}-S3ObjectCreatedFunctionAccess"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:Query
                  - dynamodb:UpdateItem
                Resource:
                  - !GetAtt BackendTable.Arn
                  - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${BackendTable}/index/*"
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: "*"
      Tags:
        - Key: CostAllocation
          Value: !Ref CostAllocationTagValue

  S3ObjectCreatedFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-S3ObjectCreatedFunction"
      Handler: main.handler
      Runtime: python3.12
      CodeUri: src/s3_object_created/
      MemorySize: 128
      Timeout: 10
      Role: !GetAtt S3ObjectCreatedFunctionRole.Arn
      Environment:
        Variables:
          LOG_LEVEL: INFO
          BACKEND_TABLE: !Ref BackendTable
          S3_PREFIX: !Ref S3Prefix

  AllowS3InvokeS3ObjectCreatedFunction:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref S3ObjectCreatedFunction
      Principal: s3.amazonaws.com
      SourceArn: !Sub "arn:aws:s3:::${FilesBucketName}"

Outputs:
  ApiBaseUrl:
    Description: "API Gateway endpoint URL for Prod stage for RIRIS backend function"
    Value: !Sub "https://${RIRISApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/"
